(function() {

  function get_csv($table) {
    var rows = [];
    $.each($table.find('tr'), function(i, row) {
      var columns = [];
      $.each($(row).children('th,td'), function(i, column) {
        columns.push('"' + $(column).text().replace(/"/g, '""') + '"');
      });
      rows.push(columns.join(','));
    });
    return rows.join('\n');
  }

  $('.table-upload').on('uploaded.ir', function(e, d) {
    import_upload(e, d, CC.table.import_url);
  });

  $('form.result').on('updated.cc', function() {
    $('table.editable').each(function() {
      var $o = $(this),
          key = $o.parent('div').parent('div').attr('id'),
          csv = get_csv($o);
      $('[name=' + key + '_csv]').val(csv);
    });
  });

}());
